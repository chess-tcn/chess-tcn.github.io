/** @license BSD-2-Clause â€” https://github.com/chess-tcn/chess-tcn.github.io/blob/main/README.md#chessjs-140 */function wt(...n){const[t,...e]=n;n=t;for(const r of e)r!==null&&(n.variations=[r,...r.variations],r.variations=[],n=r);return t}function M(n,t,e,r){return n=Error.call(this,n),Object.setPrototypeOf&&Object.setPrototypeOf(n,M.prototype),n.expected=t,n.found=e,n.location=r,n.name="SyntaxError",n}function Q(n,t,e){return e=e||" ",n.length>t?n:(t-=n.length,e+=e.repeat(t),n+e.slice(0,t))}function Pt(n,t){function e(f,l){return{type:"literal",text:f,ignoreCase:l}}function r(f,l,p){return{type:"class",parts:f,inverted:l,ignoreCase:p}}function i(f){return{type:"other",description:f}}function a(f){var l=K[f];if(!l){if(f>=K.length)var p=K.length-1;else for(p=f;!K[--p];);for(l=K[p],l={line:l.line,column:l.column};p<f;)n.charCodeAt(p)===10?(l.line++,l.column=1):l.column++,p++;K[f]=l}return l}function c(f,l,p){p=a(f);var u=a(l);return{source:Dt,start:{offset:f,line:p.line,column:p.column},end:{offset:l,line:u.line,column:u.column}}}function s(f){h<w||(h>w&&(w=h,U=[]),U.push(f))}function _(){var f,l=[];for(f=g();f!==o;)l.push(f),f=g();A(),l=Object.fromEntries(l),f=b(),A(),d++;var p=h;if(n.substr(h,3)===at){var u=at;h+=3}else u=o,d===0&&s(ke);if(u===o&&(n.substr(h,3)===lt?(u=lt,h+=3):(u=o,d===0&&s(Ce)),u===o&&(n.substr(h,7)===ft?(u=ft,h+=7):(u=o,d===0&&s(Ae)),u===o&&(n.charCodeAt(h)===42?(u=zt,h++):(u=o,d===0&&s(Se))))),u!==o?(A(),p=O(),p===o&&(p=null),p={result:u,comment:p}):(h=p,p=o),d--,p===o&&d===0&&s(Ee),u=p,u===o&&(u=null),A(),u&&u.comment)for(p=f;;){const y=p.variations[0];if(!y){p.comment=u.comment;break}p=y}return{headers:l,root:f,result:(u&&u.result)??void 0}}function g(){d++;var f=h;if(A(),n.charCodeAt(h)===91){var l=Ut;h++}else l=o,d===0&&s(Xt);if(l!==o){A(),d++,l=h;var p=[],u=n.charAt(h);if(V.test(u)?h++:(u=o,d===0&&s(W)),u!==o)for(;u!==o;)p.push(u),u=n.charAt(h),V.test(u)?h++:(u=o,d===0&&s(W));else p=o;if(l=p!==o?n.substring(l,h):p,d--,l===o&&d===0&&s(te),l!==o)if(A(),n.charCodeAt(h)===34?(p=it,h++):(p=o,d===0&&s(vt)),p!==o){d++,p=h,u=[];var y=n.charAt(h);for(ut.test(y)?h++:(y=o,d===0&&s(bt));y!==o;)u.push(y),y=n.charAt(h),ut.test(y)?h++:(y=o,d===0&&s(bt));p=n.substring(p,h),d--,d===0&&s(ee),n.charCodeAt(h)===34?(u=it,h++):(u=o,d===0&&s(vt)),u!==o?(A(),n.charCodeAt(h)===93?(u=Qt,h++):(u=o,d===0&&s(Yt)),u!==o?f=[l,p]:(h=f,f=o)):(h=f,f=o)}else h=f,f=o;else h=f,f=o}else h=f,f=o;return d--,f===o&&d===0&&s(Jt),f}function b(){var f,l=O();l===o&&(l=null);var p=[];for(f=E();f!==o;)p.push(f),f=E();return wt(l!==null?{comment:l,variations:[]}:{variations:[]},...p.flat())}function E(){var f=h;A(),d++;var l=h,p=[],u=n.charAt(h);for(F.test(u)?h++:(u=o,d===0&&s(D));u!==o;)p.push(u),u=n.charAt(h),F.test(u)?h++:(u=o,d===0&&s(D));if(n.charCodeAt(h)===46?(u=Bt,h++):(u=o,d===0&&s(ie)),u!==o){l=A();var y=[],C=n.charAt(h);for(ct.test(C)?h++:(C=o,d===0&&s(yt));C!==o;)y.push(C),C=n.charAt(h),ct.test(C)?h++:(C=o,d===0&&s(yt));l=p=[p,u,l,y]}else h=l,l=o;if(d--,l===o&&d===0&&s(re),A(),d++,u=p=h,n.substr(h,5)===st?(l=st,h+=5):(l=o,d===0&&s(ne)),l===o&&(n.substr(h,3)===nt?(l=nt,h+=3):(l=o,d===0&&s(oe)),l===o&&(n.substr(h,5)===ot?(l=ot,h+=5):(l=o,d===0&&s(he)),l===o&&(n.substr(h,3)===ht?(l=ht,h+=3):(l=o,d===0&&s(ae)),l===o))))if(l=h,y=n.charAt(h),V.test(y)?h++:(y=o,d===0&&s(W)),y!==o){C=[];var N=n.charAt(h);if(_t.test(N)?h++:(N=o,d===0&&s(Et)),N!==o)for(;N!==o;)C.push(N),N=n.charAt(h),_t.test(N)?h++:(N=o,d===0&&s(Et));else C=o;C!==o?l=y=[y,C]:(h=l,l=o)}else h=l,l=o;if(l!==o?(y=n.charAt(h),Zt.test(y)?h++:(y=o,d===0&&s(le)),y===o&&(y=null),u=l=[l,y]):(h=u,u=o),p=u!==o?n.substring(p,h):u,d--,p===o&&d===0&&s(se),p!==o){for(d++,f=h,u=[],l=n.charAt(h),pt.test(l)?h++:(l=o,d===0&&s(kt));l!==o;)u.push(l),u.length>=2?l=o:(l=n.charAt(h),pt.test(l)?h++:(l=o,d===0&&s(kt)));for(u.length<1?(h=f,f=o):f=u,d--,f===o&&d===0&&s(fe),l=f,l===o&&(l=null),f=[],u=S();u!==o;)f.push(u),u=S();for(A(),y=O(),y===o&&(y=null),u=[],C=et();C!==o;)u.push(C),C=et();p={move:p,variations:u},l&&(p.suffix=l),f&&(p.nag=f),y!==null&&(p.comment=y),f=p}else h=f,f=o;return f}function S(){d++;var f=h;if(A(),n.charCodeAt(h)===36){var l=$t;h++}else l=o,d===0&&s(ce);if(l!==o){l=h;var p=[],u=n.charAt(h);if(F.test(u)?h++:(u=o,d===0&&s(D)),u!==o)for(;u!==o;)p.push(u),u=n.charAt(h),F.test(u)?h++:(u=o,d===0&&s(D));else p=o;l=p!==o?n.substring(l,h):p,l!==o?f=l:(h=f,f=o)}else h=f,f=o;return d--,f===o&&d===0&&s(ue),f}function O(){d++;var f=h;if(n.charCodeAt(h)===123){var l=jt;h++}else l=o,d===0&&s(pe);if(l!==o){l=h;var p=[],u=n.charAt(h);for(dt.test(u)?h++:(u=o,d===0&&s(Ct));u!==o;)p.push(u),u=n.charAt(h),dt.test(u)?h++:(u=o,d===0&&s(Ct));l=n.substring(l,h),n.charCodeAt(h)===125?(p=Ht,h++):(p=o,d===0&&s(de)),p!==o?f=l.replace(/[\r\n]+/g," "):(h=f,f=o)}else h=f,f=o;if(d--,f===o&&d===0&&s(_e),f===o){if(d++,f=h,n.charCodeAt(h)===59?(l=Vt,h++):(l=o,d===0&&s(me)),l!==o){for(f=h,l=[],p=n.charAt(h),gt.test(p)?h++:(p=o,d===0&&s(At));p!==o;)l.push(p),p=n.charAt(h),gt.test(p)?h++:(p=o,d===0&&s(At));f=n.substring(f,h),f=f.trim()}else h=f,f=o;d--,f===o&&d===0&&s(ge)}return f}function et(){d++;var f=h;if(A(),n.charCodeAt(h)===40){var l=Wt;h++}else l=o,d===0&&s(be);if(l!==o)if(l=b(),l!==o){if(A(),n.charCodeAt(h)===41){var p=Gt;h++}else p=o,d===0&&s(ye);p!==o?f=l:(h=f,f=o)}else h=f,f=o;else h=f,f=o;return d--,f===o&&d===0&&s(ve),f}function A(){d++;var f=[],l=n.charAt(h);for(mt.test(l)?h++:(l=o,d===0&&s(St));l!==o;)f.push(l),l=n.charAt(h),mt.test(l)?h++:(l=o,d===0&&s(St));return d--,d===0&&s(we),f}t=t!==void 0?t:{};var o={},Dt=t.grammarSource,T={pgn:_},rt=_,Ut="[",it='"',Qt="]",Bt=".",st="O-O-O",nt="O-O",ot="0-0-0",ht="0-0",$t="$",jt="{",Ht="}",Vt=";",Wt="(",Gt=")",at="1-0",lt="0-1",ft="1/2-1/2",zt="*",V=/^[a-zA-Z]/,ut=/^[^"]/,F=/^[0-9]/,ct=/^[.]/,_t=/^[a-zA-Z1-8\-=]/,Zt=/^[+#]/,pt=/^[!?]/,dt=/^[^}]/,gt=/^[^\r\n]/,mt=/^[ \t\r\n]/,Jt=i("tag pair"),Xt=e("[",!1),vt=e('"',!1),Yt=e("]",!1),te=i("tag name"),W=r([["a","z"],["A","Z"]],!1,!1),ee=i("tag value"),bt=r(['"'],!0,!1),re=i("move number"),D=r([["0","9"]],!1,!1),ie=e(".",!1),yt=r(["."],!1,!1),se=i("standard algebraic notation"),ne=e("O-O-O",!1),oe=e("O-O",!1),he=e("0-0-0",!1),ae=e("0-0",!1),Et=r([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),le=r(["+","#"],!1,!1),fe=i("suffix annotation"),kt=r(["!","?"],!1,!1),ue=i("NAG"),ce=e("$",!1),_e=i("brace comment"),pe=e("{",!1),Ct=r(["}"],!0,!1),de=e("}",!1),ge=i("rest of line comment"),me=e(";",!1),At=r(["\r",`
`],!0,!1),ve=i("variation"),be=e("(",!1),ye=e(")",!1),Ee=i("game termination marker"),ke=e("1-0",!1),Ce=e("0-1",!1),Ae=e("1/2-1/2",!1),Se=e("*",!1),we=i("whitespace"),St=r([" ","	","\r",`
`],!1,!1),h=t.peg$currPos|0,K=[{line:1,column:1}],w=h,U=t.peg$maxFailExpected||[],d=t.peg$silentFails|0;if(t.startRule){if(!(t.startRule in T))throw Error(`Can't start parsing from rule "`+t.startRule+'".');rt=T[t.startRule]}if(T=rt(),t.peg$library)return{peg$result:T,peg$currPos:h,peg$FAILED:o,peg$maxFailExpected:U,peg$maxFailPos:w};if(T!==o&&h===n.length)return T;throw T!==o&&h<n.length&&s({type:"end"}),function(f,l,p){return new M(M.buildMessage(f,l),f,l,p)}(U,w<n.length?n.charAt(w):null,w<n.length?c(w,w+1):c(w,w))}function k(n){const t=n&15;return n>>=4,"abcdefgh".substring(t,t+1)+"87654321".substring(n,n+1)}function It(n){if(n=n.split(/\s+/),n.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};var t=parseInt(n[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};if(t=parseInt(n[4],10),isNaN(t)||t<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(n[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(n[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(n[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};if(t=n[0].split("/"),t.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(var e=0;e<t.length;e++){let r=0,i=!1;for(let a=0;a<t[e].length;a++)if("0123456789".indexOf(t[e][a])!==-1){if(i)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};r+=parseInt(t[e][a],10),i=!0}else{if(!/^[prnbqkPRNBQK]$/.test(t[e][a]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};r+=1,i=!1}if(r!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(n[3][1]=="3"&&n[1]=="w"||n[3][1]=="6"&&n[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};e=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:r,regex:i}of e){if(!i.test(n[0]))return{ok:!1,error:`Invalid FEN: missing ${r} king`};if((n[0].match(i)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${r} kings`}}return Array.from(t[0]+t[7]).some(r=>r.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function P(n,t,e,r,i,a,c=v.a){var s=r>>4;if(i!=="p"||s!==7&&s!==0)n.push({color:t,from:e,to:r,piece:i,captured:a,flags:c});else for(s=0;s<X.length;s++)n.push({color:t,from:e,to:r,piece:i,captured:a,promotion:X[s],flags:c|v.e})}function G(n){let t=n.charAt(0);return t>="a"&&t<="h"?n.match(/[a-h]\d.*[a-h]\d/)?void 0:"p":(t=t.toLowerCase(),t==="o"?"k":t)}function B(n){return n.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function z(n,t){document.querySelectorAll("nav button").forEach(e=>e.classList.remove("c")),document.querySelectorAll(".f").forEach(e=>e.classList.remove("c")),document.getElementById(t).classList.add("c"),document.getElementById(n).classList.add("c")}function Z(n){document.documentElement.setAttribute("q",n),n==="dark"?document.body.classList.add("e"):document.body.classList.remove("e")}(function(n,t){function e(){this.constructor=n}e.prototype=t.prototype,n.prototype=new e})(M,Error),M.prototype.format=function(n){var t="Error: "+this.message;if(this.location){var e=null,r;for(r=0;r<n.length;r++)if(n[r].source===this.location.source){e=n[r].text.split(/\r\n|\n|\r/g);break}n=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(n):n;var i=this.location.source+":"+r.line+":"+r.column;if(e){var a=this.location.end,c=Q("",r.line.toString().length," ");e=e[n.line-1],a=(n.line===a.line?a.column:e.length+1)-n.column||1,t+=`
 --> `+i+`
`+c+` |
`+r.line+" | "+e+`
`+c+" | "+Q("",n.column-1," ")+Q("",a,"^")}else t+=`
 at `+i}return t},M.buildMessage=function(n,t){function e(s){return s.charCodeAt(0).toString(16).toUpperCase()}function r(s){return s.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+e(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+e(_)})}function i(s){return s.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+e(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+e(_)})}function a(s){return c[s.type](s)}var c={literal:function(s){return'"'+r(s.text)+'"'},class:function(s){var _=s.parts.map(function(g){return Array.isArray(g)?i(g[0])+"-"+i(g[1]):i(g)});return"["+(s.inverted?"^":"")+_.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(s){return s.description}};return"Expected "+function(s){s=s.map(a);var _,g;if(s.sort(),s.length>0){for(g=_=1;_<s.length;_++)s[_-1]!==s[_]&&(s[g]=s[_],g++);s.length=g}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(n)+" but "+(t?'"'+r(t)+'"':"end of input")+" found."};const R=function(n){return function(){let t=BigInt(n&0xffffffffffffffffn),e=BigInt(n>>64n&0xffffffffffffffffn);var r=t*5n&0xffffffffffffffffn;return e^=t,t=((t<<24n|t>>40n)&0xffffffffffffffffn^e^e<<16n)&0xffffffffffffffffn,n=((e<<37n|e>>27n)&0xffffffffffffffffn)<<64n|t,((r<<7n|r>>57n)&0xffffffffffffffffn)*9n&0xffffffffffffffffn}}(0xa187eb39cdcaed8f31c4b365b102e01en),Nt=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>R()))),Lt=Array.from({length:8},()=>R()),Ot=Array.from({length:16},()=>R()),$=R();class q{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:r,piece:i,from:a,to:c,flags:s,captured:_,promotion:g}=e,b=k(a),E=k(c);this.color=r,this.piece=i,this.from=b,this.to=E,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=b+E,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const S in v)v[S]&s&&(this.flags+=L[S]);_&&(this.captured=_),g&&(this.promotion=g,this.lan+=g)}isCapture(){return this.flags.indexOf(L.b)>-1}isPromotion(){return this.flags.indexOf(L.e)>-1}isEnPassant(){return this.flags.indexOf(L.d)>-1}isKingsideCastle(){return this.flags.indexOf(L.f)>-1}isQueensideCastle(){return this.flags.indexOf(L.g)>-1}isBigPawn(){return this.flags.indexOf(L.c)>-1}}const L={a:"n",b:"c",c:"b",d:"e",e:"p",f:"k",g:"q",h:"-"},v={a:1,b:2,c:4,d:8,e:16,f:32,g:64,h:128},j={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Tt={...j,WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},m={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},H={b:[16,32,17,15],w:[-16,-32,-17,-15]},J={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Mt=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Kt=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Rt={p:1,n:2,b:4,r:8,q:16,k:32},X=["n","b","r","q"],x={k:v.f,q:v.g},I={w:[{square:m.a1,flag:v.g},{square:m.h1,flag:v.f}],b:[{square:m.a8,flag:v.g},{square:m.h8,flag:v.f}]},qt={b:1,w:6};class Y{_board=Array(128);_turn="w";_header={};_kings={w:-1,b:-1};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=Array(128),this._kings={w:-1,b:-1},this._turn="w",this._castling={w:0,b:0},this._epSquare=-1,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Tt},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:r=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6&&(t=i.concat(["-","-","0","1"].slice(-(6-i.length))).join(" ")),i=t.split(/\s+/),!e){const{ok:c,error:s}=It(t);if(!c)throw Error(s)}e=i[0];let a=0;for(this.clear({preserveHeaders:r}),r=0;r<e.length;r++){const c=e.charAt(r);if(c==="/")a+=8;else if("0123456789".indexOf(c)!==-1)a+=parseInt(c,10);else{const s=c<"a"?"w":"b";this._put({type:c.toLowerCase(),color:s},k(a)),a++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=v.f),i[2].indexOf("Q")>-1&&(this._castling.w|=v.g),i[2].indexOf("k")>-1&&(this._castling.b|=v.f),i[2].indexOf("q")>-1&&(this._castling.b|=v.g),this._epSquare=i[3]==="-"?-1:m[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){var e=0;let r="";for(var i=m.a8;i<=m.h1;i++){if(this._board[i]){e>0&&(r+=e,e=0);const{color:a,type:c}=this._board[i];r+=a==="w"?c.toUpperCase():c.toLowerCase()}else e++;i+1&136&&(e>0&&(r+=e),i!==m.h1&&(r+="/"),e=0,i+=8)}if(e="",this._castling.w&v.f&&(e+="K"),this._castling.w&v.g&&(e+="Q"),this._castling.b&v.f&&(e+="k"),this._castling.b&v.g&&(e+="q"),e=e||"-",i="-",this._epSquare!==-1)if(t)i=k(this._epSquare);else{t=this._epSquare+(this._turn==="w"?16:-16),t=[t+1,t-1];for(const a of t)if(!(a&136)&&(t=this._turn,this._board[a]?.color===t&&this._board[a]?.type==="p"&&(this._makeMove({color:t,from:a,to:this._epSquare,piece:"p",captured:"p",flags:v.d}),t=!this._isKingAttacked(t),this._undoMove(),t))){i=k(this._epSquare);break}}return[r,this._turn,e,i,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:r}=this._board[t];return Nt[{w:0,b:1}[e]][{p:0,n:1,b:2,r:3,q:4,k:5}[r]][t]}_epKey(){return this._epSquare===-1?0n:Lt[this._epSquare&7]}_castlingKey(){return Ot[this._castling.w>>5|this._castling.b>>3]}_computeHash(){let t=0n;for(let e=m.a8;e<=m.h1;e++)e&136?e+=7:this._board[e]&&(t^=this._pieceKey(e));return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=$),t}_updateSetup(t){this._history.length>0||(t!=="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}get(t){return this._board[m[t]]}findPiece(t){const e=[];for(let r=m.a8;r<=m.h1;r++)r&136?r+=7:this._board[r]&&this._board[r]?.color===t.color&&this._board[r].color===t.color&&this._board[r].type===t.type&&e.push(k(r));return e}put({type:t,color:e},r){return this._put({type:t,color:e},r)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},r){if("pnbrqkPNBRQK".indexOf(t.toLowerCase())===-1||!(r in m)||(r=m[r],t=="k"&&this._kings[e]!=-1&&this._kings[e]!=r))return!1;const i=this._board[r];return i&&i.type==="k"&&(this._kings[i.color]=-1),this._set(r,{type:t,color:e}),t==="k"&&(this._kings[e]=r),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(m[t]),e&&e.type==="k"&&(this._kings[e.color]=-1),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[m.e1]?.type==="k"&&this._board[m.e1]?.color==="w",e=this._board[m.e8]?.type==="k"&&this._board[m.e8]?.color==="b";t&&this._board[m.a1]?.type==="r"&&this._board[m.a1]?.color==="w"||(this._castling.w&=-65),t&&this._board[m.h1]?.type==="r"&&this._board[m.h1]?.color==="w"||(this._castling.w&=-33),e&&this._board[m.a8]?.type==="r"&&this._board[m.a8]?.color==="b"||(this._castling.b&=-65),e&&this._board[m.h8]?.type==="r"&&this._board[m.h8]?.color==="b"||(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare!==-1){var t=this._epSquare+(this._turn==="w"?16:-16),e=[t+1,t-1];this._board[this._epSquare+(this._turn==="w"?-16:16)]!==null||this._board[this._epSquare]!==null||this._board[t]?.color!==(this._turn==="w"?"b":"w")||this._board[t]?.type!=="p"?(this._hash^=this._epKey(),this._epSquare=-1):e.some(r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type==="p")||(this._hash^=this._epKey(),this._epSquare=-1)}}_attacked(t,e,r){const i=[];for(let _=m.a8;_<=m.h1;_++)if(_&136)_+=7;else if(this._board[_]!==void 0&&this._board[_].color===t){var a=this._board[_],c=_-e;if(c!==0){var s=c+119;if(Mt[s]&Rt[a.type])if(a.type==="p"){if(c>0&&a.color==="w"||c<=0&&a.color==="b")if(r)i.push(k(_));else return!0}else{if(a.type==="n"||a.type==="k")if(r){i.push(k(_));continue}else return!0;for(a=Kt[s],c=_+a,s=!1;c!==e;){if(this._board[c]!=null){s=!0;break}c+=a}if(!s)if(r)i.push(k(_));else return!0}}}return r?i:!1}attackers(t,e){return e?this._attacked(e,m[t],!0):this._attacked(this._turn,m[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(t==="w"?"b":"w",e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,m[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){var t={b:0,n:0,r:0,q:0,k:0,p:0};const e=[];var r=0,i=0;for(let a=m.a8;a<=m.h1;a++){if(i=(i+1)%2,a&136){a+=7;continue}const c=this._board[a];c&&(t[c.type]=c.type in t?t[c.type]+1:1,c.type==="b"&&e.push(i),r++)}if(r===2||r===3&&(t.b===1||t.n===1))return!0;if(r===t.b+2){for(t=0,r=e.length,i=0;i<r;i++)t+=e[i];if(t===0||t===r)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e,piece:r}={}){const i=this._moves({square:e,piece:r});return t?i.map(a=>new q(this,a)):i.map(a=>this._moveToSan(a,i))}_moves({legal:t=!0,piece:e,square:r}={}){var i=r?r.toLowerCase():void 0,a=e?.toLowerCase();e=[],r=this._turn;const c=r==="w"?"b":"w";var s=m.a8,_=m.h1;let g=!1;if(i)if(i in m)s=_=m[i],g=!0;else return[];for(i=s;i<=_;i++)if(i&136)i+=7;else if(this._board[i]&&this._board[i].color!==c){var{type:b}=this._board[i];if(b==="p"){if(!a||a===b)for(s=i+H[r][0],this._board[s]||(P(e,r,i,s,"p"),s=i+H[r][1],qt[r]!==i>>4||this._board[s]||P(e,r,i,s,"p",void 0,v.c)),b=2;b<4;b++)s=i+H[r][b],s&136||(this._board[s]?.color===c?P(e,r,i,s,"p",this._board[s].type,v.b):s===this._epSquare&&P(e,r,i,s,"p","p",v.d))}else if(!a||a===b)for(let E=0,S=J[b].length;E<S;E++){const O=J[b][E];for(s=i;s+=O,!(s&136);){if(this._board[s]){if(this._board[s].color===r)break;P(e,r,i,s,b,this._board[s].type,v.b);break}else P(e,r,i,s,b);if(b==="n"||b==="k")break}}}if((a===void 0||a==="k")&&(g&&_!==this._kings[r]||(this._castling[r]&v.f&&(a=this._kings[r],_=a+2,this._board[a+1]||this._board[_]||this._attacked(c,this._kings[r])||this._attacked(c,a+1)||this._attacked(c,_)||P(e,r,this._kings[r],_,"k",void 0,v.f)),this._castling[r]&v.g&&(a=this._kings[r],_=a-2,this._board[a-1]||this._board[a-2]||this._board[a-3]||this._attacked(c,this._kings[r])||this._attacked(c,a-1)||this._attacked(c,_)||P(e,r,this._kings[r],_,"k",void 0,v.g)))),!t||this._kings[r]===-1)return e;t=[];for(let E=0,S=e.length;E<S;E++)this._makeMove(e[E]),this._isKingAttacked(r)||t.push(e[E]),this._undoMove();return t}move(t,{strict:e=!1}={}){let r=null;if(typeof t=="string")r=this._moveFromSan(t,e);else if(t===null)r=this._moveFromSan("--",e);else if(typeof t=="object"){e=this._moves();for(let i=0,a=e.length;i<a;i++)if(!(t.from!==k(e[i].from)||t.to!==k(e[i].to)||"promotion"in e[i]&&t.promotion!==e[i].promotion)){r=e[i];break}}if(!r)throw Error(typeof t=="string"?`Invalid move: ${t}`:`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&r.flags&v.h)throw Error("Null move not allowed when in check");return t=new q(this,r),this._makeMove(r),this._incPositionCount(),t}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,r=e==="w"?"b":"w";if(this._push(t),t.flags&v.h)e==="b"&&this._moveNumber++,this._halfMoves++,this._turn=r,this._epSquare=-1;else{if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&v.d&&(this._turn==="b"?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type==="k"&&(this._kings[e]=t.to,t.flags&v.f?this._movePiece(t.to+1,t.to-1):t.flags&v.g&&this._movePiece(t.to-2,t.to+1),this._castling[e]=0),this._castling[e]){for(let i=0,a=I[e].length;i<a;i++)if(t.from===I[e][i].square&&this._castling[e]&I[e][i].flag){this._castling[e]^=I[e][i].flag;break}}if(this._castling[r]){for(let i=0,a=I[r].length;i<a;i++)if(t.to===I[r][i].square&&this._castling[r]&I[r][i].flag){this._castling[r]^=I[r][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&v.c){let i;i=e==="b"?t.to-16:t.to+16,(t.to-1&136||this._board[t.to-1]?.type!=="p"||this._board[t.to-1]?.color!==r)&&(t.to+1&136||this._board[t.to+1]?.type!=="p"||this._board[t.to+1]?.color!==r)?this._epSquare=-1:(this._epSquare=i,this._hash^=this._epKey())}else this._epSquare=-1;t.piece==="p"?this._halfMoves=0:t.flags&(v.b|v.d)?this._halfMoves=0:this._halfMoves++,e==="b"&&this._moveNumber++,this._turn=r,this._hash^=$}}undo(){const t=this._hash;var e=this._undoMove();return e?(e=new q(this,e),this._decPositionCount(t),e):null}_undoMove(){var t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=$,t=this._turn;var r=t==="w"?"b":"w";return e.flags&v.h||(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:t})),e.captured&&(e.flags&v.d?this._set(t==="b"?e.to-16:e.to+16,{type:"p",color:r}):this._set(e.to,{type:e.captured,color:r})),e.flags&(v.f|v.g)&&(e.flags&v.f?(t=e.to+1,r=e.to-1):(t=e.to-2,r=e.to+1),this._movePiece(r,t))),e}pgn({newline:t=`
`,maxWidth:e=0}={}){const r=[];var i=!1;for(var a in this._header)this._header[a]&&r.push(`[${a} "${this._header[a]}"]`+t),i=!0;i&&this._history.length&&r.push(t),a=g=>{const b=this._comments[this.fen()];return typeof b<"u"&&(g=`${g}${g.length>0?" ":""}{${b}}`),g};for(var c=[];this._history.length>0;)c.push(this._undoMove());i=[];var s="";for(c.length===0&&i.push(a(""));c.length>0;){s=a(s);const g=c.pop();if(!g)break;if(this._history.length||g.color!=="b")g.color==="w"&&(s.length&&i.push(s),s=this._moveNumber+".");else{const b=`${this._moveNumber}. ...`;s=s?`${s} ${b}`:b}s=s+" "+this._moveToSan(g,this._moves({legal:!0})),this._makeMove(g)}if(s.length&&i.push(a(s)),i.push(this._header.Result||"*"),e===0)return r.join("")+i.join(" ");const _=function(){return r.length>0&&r[r.length-1]===" "?(r.pop(),!0):!1};for(a=function(g,b){for(const E of b.split(" "))if(E){if(g+E.length>e){for(;_();)g--;r.push(t),g=0}r.push(E),g+=E.length,r.push(" "),g++}return _()&&g--,g},c=0,s=0;s<i.length;s++)c+i[s].length>e&&i[s].includes("{")?c=a(c,i[s]):(c+i[s].length>e&&s!==0?(r[r.length-1]===" "&&r.pop(),r.push(t),c=0):s!==0&&(r.push(" "),c++),r.push(i[s]),c+=i[s].length);return r.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??j[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=j[t]||null,!0):!1}getHeaders(){const t={};for(const[e,r]of Object.entries(this._header))r!==null&&(t[e]=r);return t}loadPgn(t,{strict:e=!1,newlineChar:r=`\r?
`}={}){r!==`\r?
`&&(t=t.replace(new RegExp(r,"g"),`
`)),t=Pt(t),this.reset(),r=t.headers;let i="";for(var a in r)a.toLowerCase()==="fen"&&(i=r[a]),this.header(a,r[a]);if(!e)i&&this.load(i,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}for(a=t.root;a;){if(a.move){if(r=this._moveFromSan(a.move,e),r==null)throw Error(`Invalid move in PGN: ${a.move}`);this._makeMove(r),this._incPositionCount()}a.comment!==void 0&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}(e=t.result)&&Object.keys(this._header).length&&this._header.Result!==e&&this.setHeader("Result",e)}_moveToSan(t,e){let r="";if(t.flags&v.f)r="O-O";else if(t.flags&v.g)r="O-O-O";else{if(t.flags&v.h)return"--";if(t.piece!=="p"){const i=t.from,a=t.to,c=t.piece;let s=0,_=0,g=0;for(let b=0,E=e.length;b<E;b++){const S=e[b].from,O=e[b].to;c===e[b].piece&&i!==S&&a===O&&(s++,i>>4===S>>4&&_++,(i&15)===(S&15)&&g++)}e=s>0?_>0&&g>0?k(i):g>0?k(i).charAt(1):k(i).charAt(0):"",r+=t.piece.toUpperCase()+e}t.flags&(v.b|v.d)&&(t.piece==="p"&&(r+=k(t.from)[0]),r+="x"),r+=k(t.to),t.promotion&&(r+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(r=this.isCheckmate()?r+"#":r+"+"),this._undoMove(),r}_moveFromSan(t,e=!1){if(t=B(t),e||(t==="0-0"?t="O-O":t==="0-0-0"&&(t="O-O-O")),t=="--")return{color:this._turn,from:0,to:0,piece:"k",flags:v.h};var r=G(t);r=this._moves({legal:!0,piece:r});for(let _=0,g=r.length;_<g;_++)if(t===B(this._moveToSan(r[_],r)))return r[_];if(e)return null;let i=e=void 0,a,c,s=!1;if(((r=t.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/))||(r=t.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/)))&&(e=r[1],i=r[2],a=r[3],c=r[4],i.length==1&&(s=!0)),r=G(t),r=this._moves({legal:!0,piece:e||r}),!a)return null;for(let _=0,g=r.length;_<g;_++)if(i){if(!(e&&e.toLowerCase()!=r[_].piece||m[i]!=r[_].from||m[a]!=r[_].to||c&&c.toLowerCase()!=r[_].promotion))return r[_];if(s){const b=k(r[_].from);if(!(e&&e.toLowerCase()!=r[_].piece||m[a]!=r[_].to||i!=b[0]&&i!=b[1]||c&&c.toLowerCase()!=r[_].promotion))return r[_]}}else if(t===B(this._moveToSan(r[_],r)).replace("x",""))return r[_];return null}ascii(){let t=`   +------------------------+
`;for(let r=m.a8;r<=m.h1;r++){if((r&15)===0&&(t+=" "+"87654321"[r>>4]+" |"),this._board[r]){var e=this._board[r].type;e=this._board[r].color==="w"?e.toUpperCase():e.toLowerCase(),t+=" "+e+" "}else t+=" . ";r+1&136&&(t+=`|
`,r+=8)}return t+`   +------------------------+
     a  b  c  d  e  f  g  h`}perft(t){const e=this._moves({legal:!1});let r=0;const i=this._turn;for(let a=0,c=e.length;a<c;a++)this._makeMove(e[a]),this._isKingAttacked(i)||(t-1>0?r+=this.perft(t-1):r++),this._undoMove();return r}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let r=m.a8;r<=m.h1;r++)this._board[r]==null?e.push(null):e.push({square:k(r),type:this._board[r].type,color:this._board[r].color}),r+1&136&&(t.push(e),e=[],r+=8);return t}squareColor(t){return t in m?(t=m[t],((t>>4)+(t&15))%2===0?"light":"dark"):null}history({verbose:t=!1}={}){const e=[],r=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?r.push(new q(this,i)):r.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return r}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},r=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(r(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),r(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const r of["k","q"])e[r]!==void 0&&(this._castling[t]=e[r]?this._castling[t]|x[r]:this._castling[t]&~x[r]);return this._updateCastlingRights(),t=this.getCastlingRights(t),(e.k===void 0||e.k===t.k)&&(e.q===void 0||e.q===t.q)}getCastlingRights(t){return{k:(this._castling[t]&x.k)!==0,q:(this._castling[t]&x.q)!==0}}moveNumber(){return this._moveNumber}}document.getElementById("a").onclick=()=>z("c","a"),document.getElementById("b").onclick=()=>z("i","b");const xt=document.getElementById("d"),Ft=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";Z(window.localStorage.getItem("theme")||Ft),xt.onclick=()=>{const n=document.body.classList.contains("e")?"light":"dark";Z(n),window.localStorage.setItem("theme",n)};let tt="";document.getElementById("f").addEventListener("click",function(){var n=document.getElementById("e").value;if(n){var t=new Y;try{t.loadPgn(n)}catch{return void alert("Invalid PGN")}t=t.history({verbose:!0}),n="";for(const s of t){t={d:s.from,c:s.to},s.promotion&&(t.a=s.promotion);var e=t,r="";Array.isArray(e)||(e=[e]);var i=e.length;for(t=0;t<i;t+=1){var a=e[t].b?79+"qnrbkp".indexOf(e[t].b):"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++=".indexOf(e[t].d[0])+8*(e[t].d[1]-1),c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++=".indexOf(e[t].c[0])+8*(e[t].c[1]-1);e[t].a&&(c=3*"qnrbkp".indexOf(e[t].a)+64+(c<a?9+c-a:c-a-7)),r+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++="[a]+"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++="[c]}n+=r}document.getElementById("g").value=n}else alert("Please paste a game.")}),document.getElementById("h").addEventListener("click",function(){const n=document.getElementById("g").value;navigator.clipboard.writeText(n)}),document.getElementById("k").addEventListener("click",function(){var n=document.getElementById("j").value.trim();if(n){var t=new Y;for(let g=0;g<n.length;g+=2)try{var e=void 0,r=void 0,i=n[g]+n[g+1],a=i.length,c=[];for(r=0;r<a;r+=2){var s={},_="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++=".indexOf(i[r]);(e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++=".indexOf(i[r+1]))>63&&(s.a="qnrbkp"[Math.floor((e-64)/3)],e=_+(_<16?-8:8)+(e-1)%3-1),_>75?s.b="qnrbkp"[_-79]:s.d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++="[_%8]+(Math.floor(_/8)+1),s.c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?{~}(^)[_]@#$,./&-*++="[e%8]+(Math.floor(e/8)+1),c.push(s)}let b=c[0],E={to:b.c,from:b.d};b.a&&(E.promotion=b.a),t.move(E,{sloppy:!0})}catch{return void alert("Invalid TCN or out-of-sync move encountered")}t.history(),tt=n=t.pgn({max_width:0,newline_char:" "}),document.getElementById("n").textContent=n,document.getElementById("l").style.display="block"}}),document.getElementById("m").addEventListener("click",function(n){navigator.clipboard.writeText(tt)})
